# æˆªå›¾å¤„ç†æµæ°´çº¿ - é€šä¿—å›¾è§£è¯´æ˜

> æœ¬æ–‡æ¡£ç”¨é€šä¿—æ˜“æ‡‚çš„è¯­è¨€å’Œå›¾è§£ï¼Œè§£é‡Šä»æˆªå›¾é‡‡é›†åˆ°çŸ¥è¯†å›¾è°±ç”Ÿæˆçš„å®Œæ•´æµç¨‹ã€‚

---

## ğŸ“¸ ä¸€ã€å®Œæ•´æµç¨‹æ¦‚è§ˆ

æƒ³è±¡ä¸€ä¸‹ï¼Œè¿™ä¸ªç³»ç»Ÿå°±åƒä¸€ä¸ª**æ™ºèƒ½ç…§ç‰‡å·¥å‚**ï¼ŒæŠŠä½ ç”µè„‘ä¸Šçš„æˆªå›¾å˜æˆå¯æœç´¢çš„çŸ¥è¯†åº“ï¼š

```
æˆªå›¾é‡‡é›† â†’ ä¸´æ—¶ä»“åº“ â†’ æ‰“åŒ…è£…ç®± â†’ AIåˆ†æ â†’ çŸ¥è¯†æå– â†’ çŸ¥è¯†å›¾è°±
  ğŸ“·        ğŸ“¦          ğŸ         ğŸ¤–        ğŸ“          ğŸ•¸ï¸
```

### æµç¨‹ç±»æ¯”

1. **ğŸ“· æˆªå›¾é‡‡é›†** = ç”¨ç›¸æœºæ‹ç…§
2. **ğŸ“¦ ä¸´æ—¶ä»“åº“** = å…ˆæ”¾åœ¨å·¥ä½œå°ä¸Šæ”’ä¸€å †
3. **ğŸ æ‰“åŒ…è£…ç®±** = 5å¼ ä¸€ç»„æ‰“åŒ…ï¼ˆæ–¹ä¾¿è¿è¾“ï¼‰
4. **ğŸ¤– AIåˆ†æ** = æ‰¾ä¸“å®¶çœ‹ç…§ç‰‡å†…å®¹
5. **ğŸ“ çŸ¥è¯†æå–** = ä¸“å®¶å†™æŠ¥å‘Šæ€»ç»“
6. **ğŸ•¸ï¸ çŸ¥è¯†å›¾è°±** = æŠŠæŠ¥å‘Šå½’æ¡£åˆ°å›¾ä¹¦é¦†

---

## ğŸ¬ äºŒã€æ•°æ®æµè¯¦è§£ï¼ˆå¸¦å®ä¾‹ï¼‰

### é˜¶æ®µ1: æˆªå›¾å®Œæˆ â†’ å…¥åº“

**ä»£ç ä½ç½®**: `screenshot-processing-module.ts` L127-L162

**å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ**

```javascript
// ä½ åœ¨ VSCode å†™ä»£ç ï¼Œç³»ç»Ÿæ‹äº†ä¸€å¼ æˆªå›¾
æˆªå›¾ {
  æ—¶é—´: "16:30:25",
  æ–‡ä»¶è·¯å¾„: "/captures/screen_001.jpg", 
  åº”ç”¨: "VSCode",
  çª—å£æ ‡é¢˜: "main.py - Visual Studio Code",
  å›¾ç‰‡æ•°æ®: <äºŒè¿›åˆ¶>
}
```

**è¿™ä¸€æ­¥åšä»€ä¹ˆï¼Ÿ**

1. âœ… **å»é‡æ£€æŸ¥**ï¼šè®¡ç®—å›¾ç‰‡æŒ‡çº¹(pHash)ï¼Œå¦‚æœå’Œä¸Šä¸€å¼ ä¸€æ ·å°±ä¸¢å¼ƒ
   - æ¯”å¦‚ï¼šä½ ç›¯ç€åŒä¸€ä¸ªé¡µé¢çœ‹äº†10ç§’ï¼Œåªä¿ç•™1å¼ æˆªå›¾
   
2. âœ… **æ¥æºæ£€æŸ¥**ï¼šç¡®è®¤è¿™æ˜¯ä½ æ­£åœ¨å…³æ³¨çš„çª—å£/å±å¹•
   - åªä¿å­˜ä½ é€‰æ‹©ç›‘æ§çš„åº”ç”¨ï¼ˆæ¯”å¦‚åªç›‘æ§ VSCode å’Œæµè§ˆå™¨ï¼‰
   
3. âœ… **å…¥åº“ä¿å­˜**ï¼šå­˜å…¥æ•°æ®åº“ `screenshots` è¡¨
   ```sql
   INSERT INTO screenshots (
     ts=16:30:25,
     filePath="/captures/001.jpg",
     sourceKey="window:123",
     appHint="VSCode",
     vlmStatus="pending"  â† æ ‡è®°ä¸º"å¾…å¤„ç†"
   )
   ```

**æ•°æ®å˜åŒ–**:
```
è¾“å…¥: åŸå§‹æˆªå›¾æ–‡ä»¶
      â†“
è¾“å‡º: æ•°æ®åº“è®°å½• + ç­‰å¾…å¤„ç†æ ‡è®°
```

---

### é˜¶æ®µ2: ä¸´æ—¶ä»“åº“ â†’ æ‰¹æ¬¡æ‰“åŒ…

**ä»£ç ä½ç½®**: `source-buffer-registry.ts` L420-L460

**å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ**

æƒ³è±¡æœ‰ä¸ª**æ™ºèƒ½æ•´ç†ç®±**ï¼ˆBufferï¼‰ï¼Œä¸“é—¨æ”¶é›†åŒä¸€æ¥æºçš„æˆªå›¾ï¼š

```
Buffer[VSCodeçª—å£]:
  [æˆªå›¾1] 16:30:25 - å†™äº†ä¸ªå‡½æ•°
  [æˆªå›¾2] 16:30:30 - æ·»åŠ æ³¨é‡Š
  [æˆªå›¾3] 16:30:35 - è¿è¡Œæµ‹è¯•
  [æˆªå›¾4] 16:30:40 - æŸ¥çœ‹ç»“æœ
  [æˆªå›¾5] 16:30:45 - æäº¤ä»£ç 
  
â†’ å‡‘å¤Ÿ5å¼ ï¼Œè§¦å‘æ‰“åŒ…ï¼
```

**æ‰“åŒ…è§¦å‘æ¡ä»¶**ï¼ˆæ»¡è¶³å…¶ä¸€ï¼‰:

1. **æ•°é‡å¤Ÿäº†**: â‰¥ 5å¼ æˆªå›¾
2. **ç­‰å¤ªä¹…äº†**: è¶…è¿‡30ç§’è¿˜æ²¡å‡‘å¤Ÿ

**ä¸ºä»€ä¹ˆè¦æ‰“åŒ…ï¼Ÿ**

- ğŸšš AIå¤„ç†æœ‰"è¿è´¹"ï¼Œä¸€æ¬¡é€5å¼ æ¯”é€5æ¬¡åˆ’ç®—
- âš¡ 5å¼ ä¸€èµ·çœ‹ï¼ŒAIèƒ½ç†è§£å‰åå…³è”ï¼ˆæ¯”å¦‚ï¼šå†™ä»£ç â†’æµ‹è¯•â†’ä¿®bugï¼‰

**æ•°æ®å˜åŒ–**:
```
è¾“å…¥: 5å¼ ç‹¬ç«‹æˆªå›¾
      â†“
è¾“å‡º: BatchReadyEvent äº‹ä»¶
      {
        sourceKey: "window:VSCode",
        screenshots: [5å¼ æˆªå›¾]
      }
```

---

### é˜¶æ®µ3: æ‰¹æ¬¡æŒä¹…åŒ– + å†å²ä¸Šä¸‹æ–‡

**ä»£ç ä½ç½®**: `batch-builder.ts` L312-L322

**å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ**

ç°åœ¨è¦ç»™è¿™5å¼ æˆªå›¾**åšæ ‡ç­¾**ï¼Œæ–¹ä¾¿åç»­è¿½è¸ªï¼š

```javascript
æ‰¹æ¬¡ä¿¡æ¯ {
  batchId: "batch_20260112_163045_a3f2",  // å”¯ä¸€ç¼–å·
  æ¥æº: "window:VSCode",
  æˆªå›¾åˆ—è¡¨: [æˆªå›¾1, 2, 3, 4, 5],
  æ—¶é—´èŒƒå›´: "16:30:25 â†’ 16:30:45",
  
  // é‡è¦ï¼å¸¦ä¸Š"å†å²ä½œä¸š"
  å†å²åŒ…: {
    æœ€è¿‘3ä¸ªçº¿ç¨‹: [
      "thread_001: å¼€å‘FastAPIæ¥å£",
      "thread_002: å†™å•å…ƒæµ‹è¯•", 
      "thread_003: ä¿®å¤ç™»å½•bug"
    ],
    è¿›è¡Œä¸­çš„æ´»åŠ¨: [
      "ç¼–å†™ç”¨æˆ·è®¤è¯æ¨¡å—"
    ],
    æœ€è¿‘æåˆ°çš„å®ä½“: [
      "FastAPI", "Python", "JWT", "PostgreSQL"
    ]
  }
}
```

**ä¸ºä»€ä¹ˆè¦å¸¦å†å²åŒ…ï¼Ÿ**

å°±åƒä½ çœ‹åŒ»ç”Ÿï¼ŒåŒ»ç”Ÿè¦çœ‹ä½ çš„**ç—…å†**æ‰èƒ½æ›´å‡†ç¡®è¯Šæ–­ã€‚AIçœ‹è¿™5å¼ æˆªå›¾æ—¶ï¼Œä¹Ÿéœ€è¦çŸ¥é“ï¼š
- ä½ æœ€è¿‘åœ¨å¿™ä»€ä¹ˆé¡¹ç›®ï¼Ÿ
- æœ‰å“ªäº›ä»»åŠ¡è¿˜æ²¡å®Œæˆï¼Ÿ
- å¸¸ç”¨å“ªäº›æŠ€æœ¯æ ˆï¼Ÿ

è¿™æ ·AIæ‰èƒ½æŠŠæ–°æˆªå›¾æ­£ç¡®å½’ç±»åˆ°å·²æœ‰çš„"å·¥ä½œçº¿ç¨‹"é‡Œã€‚

**æ•°æ®è½åº“**:
```sql
INSERT INTO batches (
  batchId="batch_001",
  sourceKey="window:VSCode",
  screenshotIds=[1,2,3,4,5],
  historyPack=<JSON>,
  status="pending",
  attempts=0
)
```

**è§¦å‘**: å‘å‡º `batch:persisted` äº‹ä»¶ â†’ å”¤é†’è°ƒåº¦å™¨

---

### é˜¶æ®µ4: åˆ†ç‰‡å¤„ç† (Sharding)

**ä»£ç ä½ç½®**: `batch-builder.ts` L167-L211

**ä¸ºä»€ä¹ˆè¦åˆ†ç‰‡ï¼Ÿ**

AIè§†è§‰æ¨¡å‹(VLM)æœ‰ä¸ªé™åˆ¶ï¼š**ä¸€æ¬¡æœ€å¤šçœ‹5å¼ å›¾**ï¼ˆå°±åƒä¸€æ¬¡åªèƒ½åƒä¸‹ä¸€ç¢—é¥­ï¼‰ã€‚

å¦‚æœè¿™ä¸ªbatchæœ‰12å¼ æˆªå›¾æ€ä¹ˆåŠï¼Ÿ

```
æ‰¹æ¬¡: 12å¼ æˆªå›¾
  â†“ åˆ†ç‰‡
Shard 0: æˆªå›¾ 1-5
Shard 1: æˆªå›¾ 6-10  
Shard 2: æˆªå›¾ 11-12

æ¯ä¸ªshardç‹¬ç«‹å¤„ç†ï¼Œæœ€åå†åˆå¹¶ç»“æœ
```

**ä¸ºä»€ä¹ˆä¸ç”¨åˆ†ç‰‡æ—¶è¿˜è¦è¿™ä¸€æ­¥ï¼Ÿ**

ç»Ÿä¸€å¤„ç†é€»è¾‘ï¼5å¼ æˆªå›¾ä¹Ÿå˜æˆ"1ä¸ªshard"ï¼Œä»£ç æ›´ç®€æ´ã€‚

**æ•°æ®å˜åŒ–**:
```
è¾“å…¥: Batch { 12å¼ æˆªå›¾ }
      â†“
è¾“å‡º: [Shard0, Shard1, Shard2]
      æ¯ä¸ªShardéƒ½åŒ…å«åŒæ ·çš„historPack
```

---

### é˜¶æ®µ5: VLMè§†è§‰åˆ†æ ğŸ¤–ğŸ‘ï¸

**ä»£ç ä½ç½®**: `vlm-processor.ts` L396-L457

**è¿™æ˜¯æœ€æ ¸å¿ƒçš„æ­¥éª¤ï¼AIè¦"çœ‹æ‡‚"ä½ çš„æˆªå›¾ã€‚**

#### 5.1 VLMå¤„ç†å•ä¸ªShard

**è¾“å…¥ç»™AIçš„å†…å®¹**:
```javascript
è¯·æ±‚ {
  ç³»ç»Ÿæç¤º: "ä½ æ˜¯ä¸ªä¸“ä¸šçš„å±å¹•æ´»åŠ¨åˆ†æå¸ˆ...",
  
  ç”¨æˆ·å†…å®¹: [
    {type: "text", text: `
      æˆªå›¾å…ƒæ•°æ®:
      - æˆªå›¾1: 16:30:25, VSCode, main.py
      - æˆªå›¾2: 16:30:30, VSCode, main.py
      
      å†å²ä¸Šä¸‹æ–‡:
      - æœ€è¿‘çº¿ç¨‹: "å¼€å‘FastAPIæ¥å£"
      - è¿›è¡Œä¸­: "ç¼–å†™ç”¨æˆ·è®¤è¯æ¨¡å—"
      - å¸¸ç”¨å®ä½“: FastAPI, Python
      
      è¯·åˆ†æè¿™äº›æˆªå›¾æ˜¾ç¤ºçš„æ´»åŠ¨...
    `},
    {type: "image", image: "data:image/jpeg;base64,/9j/4AAQ..."},
    {type: "image", image: "data:image/jpeg;base64,/9j/4AAQ..."}
  ]
}
```

**AIè¿”å›çš„åˆ†æç»“æœ**:
```javascript
VLMè¾“å‡º {
  segments: [  // "æ´»åŠ¨ç‰‡æ®µ"
    {
      segment_id: "seg_001",
      screen_ids: [1, 2],  // æ¶‰åŠæˆªå›¾1å’Œ2
      
      event: {
        title: "ç¼–å†™FastAPIè·¯ç”±å‡½æ•°",
        summary: "ç”¨æˆ·åœ¨VSCodeä¸­åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„APIç«¯ç‚¹ /users/loginï¼Œä½¿ç”¨FastAPIæ¡†æ¶å®šä¹‰è·¯ç”±å’Œè¯·æ±‚æ¨¡å‹",
        importance: 7,  // é‡è¦æ€§è¯„åˆ† 1-10
        confidence: 9   // ç½®ä¿¡åº¦ 1-10
      },
      
      derived: {  // "è¡ç”ŸçŸ¥è¯†"
        knowledge: [
          {
            title: "FastAPIè·¯ç”±è£…é¥°å™¨ç”¨æ³•",
            summary: "ä½¿ç”¨@app.postè£…é¥°å™¨å®šä¹‰POSTè¯·æ±‚ç«¯ç‚¹"
          }
        ],
        state: [
          {
            title: "å¼€å‘è¿›åº¦",
            summary: "ç”¨æˆ·è®¤è¯æ¨¡å—çš„ç™»å½•æ¥å£å·²å®Œæˆå®šä¹‰"
          }
        ],
        procedure: [
          {
            title: "åˆ›å»ºAPIç«¯ç‚¹çš„æ­¥éª¤",
            summary: "1.å¯¼å…¥FastAPI 2.å®šä¹‰è·¯ç”± 3.ç¼–å†™å¤„ç†å‡½æ•°",
            steps: ["å¯¼å…¥ä¾èµ–", "å®šä¹‰è·¯ç”±", "å®ç°é€»è¾‘"]
          }
        ]
      },
      
      merge_hint: {
        decision: "MERGE",  // åº”è¯¥åˆå¹¶åˆ°å·²æœ‰çº¿ç¨‹
        thread_id: "thread_001"  // åˆå¹¶åˆ°"å¼€å‘FastAPIæ¥å£"
      },
      
      keywords: ["FastAPI", "è·¯ç”±", "ç™»å½•", "API"]
    }
  ],
  
  entities: ["FastAPI", "Python", "Pydantic", "JWT"],  // è¯†åˆ«çš„å®ä½“
  
  screenshots: [  // æ¯å¼ æˆªå›¾çš„è¯¦ç»†åˆ†æ
    {
      screenshot_id: 1,
      ocr_text: "def login(request: LoginRequest):\n    ...",  // OCRæå–çš„æ–‡å­—
      ui_text_snippets: ["@app.post", "/users/login"],  // å…³é”®UIæ–‡æœ¬
      app_guess: { name: "VSCode", confidence: 0.95 }  // åº”ç”¨è¯†åˆ«
    }
  ]
}
```

#### 5.2 å¹¶å‘å¤„ç†æ‰€æœ‰Shards

```
Shard 0 â”€â”€â”€â”€â”
            â”œâ”€â”€â†’ å¹¶å‘å¤„ç† (åŒæ—¶æœ€å¤š4ä¸ª)
Shard 1 â”€â”€â”€â”€â”¤
            â”œâ”€â”€â†’ æ¯ä¸ªè·å–VLM semaphoreè®¸å¯
Shard 2 â”€â”€â”€â”€â”˜
   â†“
ç»“æœåˆå¹¶
```

**å¹¶å‘æ§åˆ¶çš„åŸå› **:
- VLM APIå¾ˆè´µï¼Œæœ‰è°ƒç”¨é¢‘ç‡é™åˆ¶
- åŒæ—¶è°ƒç”¨å¤ªå¤šä¼šè¢«é™æµ
- Semaphore = "å…¥åœºåˆ¸"ï¼Œæ‹¿åˆ°æ‰èƒ½è°ƒç”¨

#### 5.3 åˆå¹¶Shardç»“æœ

```javascript
åˆå¹¶é€»è¾‘ {
  // 1. åˆå¹¶segmentsï¼ˆæŒ‰æ—¶é—´é¡ºåºï¼‰
  segments: [...shard0.segments, ...shard1.segments]
  
  // 2. å»é‡entities  
  entities: unique([...shard0.entities, ...shard1.entities])
  
  // 3. è¾¹ç•Œå»é‡ï¼šç›¸é‚»shardçš„æœ€å/ç¬¬ä¸€ä¸ªsegmentå¦‚æœç›¸ä¼¼ï¼Œåˆå¹¶å®ƒä»¬
  if (shard0.last.title === shard1.first.title) {
    merge(shard0.last, shard1.first)
  }
}
```

**æ•°æ®è½åº“**:
```sql
UPDATE screenshots 
SET 
  vlmStatus="succeeded",
  ocrText="def login...",
  uiTextSnippets='["@app.post", "/users/login"]',
  detectedEntities='["FastAPI","Python"]'
WHERE id IN (1,2,3,4,5)
```

---

### é˜¶æ®µ6: Text LLM æ‰©å±• ğŸ“

**ä»£ç ä½ç½®**: `text-llm-processor.ts` L130-L206

**ä¸ºä»€ä¹ˆè¿˜éœ€è¦Text LLMï¼ŸVLMä¸å¤Ÿå—ï¼Ÿ**

VLMæ“…é•¿**çœ‹å›¾**ï¼ŒText LLMæ“…é•¿**æ¨ç†å’Œå½’çº³**ã€‚å°±åƒï¼š
- VLM = ğŸ” ä¾¦æ¢ï¼ˆè§‚å¯Ÿç°åœºï¼‰
- Text LLM = ğŸ§  åˆ†æå¸ˆï¼ˆå†™æŠ¥å‘Šï¼‰

#### 6.1 æ„å»ºè¯¦ç»†Prompt

**è¾“å…¥ç»™Text LLM**:
```javascript
è¯·æ±‚ {
  ç³»ç»Ÿæç¤º: "ä½ æ˜¯ä¸ªä¸“ä¸šçš„çŸ¥è¯†å·¥ç¨‹å¸ˆï¼Œè´Ÿè´£æŠŠæ´»åŠ¨ç‰‡æ®µè½¬æ¢ä¸ºç»“æ„åŒ–çŸ¥è¯†èŠ‚ç‚¹...",
  
  ç”¨æˆ·å†…å®¹: `
    å½“å‰æ—¶é—´: 2026-01-12 16:30:45 (Asia/Shanghai, UTC+08:00)
    
    VLMåˆ†æçš„segments:
    ${JSON.stringify(vlmIndex.segments)}
    
    æˆªå›¾IDæ˜ å°„:
    - screen_id 1 â†’ database_id 123 (16:30:25, VSCode)
    - screen_id 2 â†’ database_id 124 (16:30:30, VSCode)
    
    è¯æ®åŒ…:
    - screenshot 123: ocrText="def login...", uiSnippets=["@app.post"]
    
    è¯·ç”Ÿæˆcontext nodeså’Œå®ƒä»¬ä¹‹é—´çš„å…³ç³»...
  `
}
```

**Text LLMè¿”å›**:
```javascript
TextLLMè¾“å‡º {
  nodes: [
    // Event node (ä¸»äº‹ä»¶)
    {
      kind: "event",
      thread_id: "thread_001",  // å½’å±çº¿ç¨‹
      title: "ç¼–å†™FastAPIç™»å½•æ¥å£",
      summary: "åœ¨main.pyä¸­å®ç°äº†ç”¨æˆ·ç™»å½•çš„APIç«¯ç‚¹ï¼Œä½¿ç”¨Pydanticæ¨¡å‹éªŒè¯è¯·æ±‚ï¼Œè¿”å›JWT token",
      keywords: ["FastAPI", "ç™»å½•", "JWT", "API"],
      entities: [
        {name: "FastAPI", entityType: "technology", confidence: 0.9},
        {name: "JWT", entityType: "technology", confidence: 0.8}
      ],
      importance: 7,
      confidence: 9,
      screenshot_ids: [123, 124],  // å…³è”çš„æˆªå›¾
      event_time: 1736672987500  // äº‹ä»¶å‘ç”Ÿæ—¶é—´
    },
    
    // Derived node - Knowledge (çŸ¥è¯†)
    {
      kind: "knowledge",
      title: "FastAPIè·¯ç”±è£…é¥°å™¨",
      summary: "@app.postè£…é¥°å™¨ç”¨äºå®šä¹‰POSTè¯·æ±‚çš„APIç«¯ç‚¹ï¼Œéœ€è¦æŒ‡å®šè·¯å¾„å’Œå“åº”æ¨¡å‹",
      keywords: ["FastAPI", "è£…é¥°å™¨", "è·¯ç”±"],
      entities: [{name: "FastAPI", entityType: "technology"}],
      importance: 5,
      confidence: 8,
      screenshot_ids: [123, 124]
    },
    
    // Derived node - Procedure (æ­¥éª¤)
    {
      kind: "procedure",
      title: "åˆ›å»ºFastAPIç«¯ç‚¹çš„æµç¨‹",
      summary: "1.å¯¼å…¥FastAPIå’Œæ¨¡å‹ç±» 2.ä½¿ç”¨è£…é¥°å™¨å®šä¹‰è·¯ç”± 3.ç¼–å†™å¤„ç†å‡½æ•° 4.è¿”å›å“åº”",
      keywords: ["FastAPI", "å¼€å‘æµç¨‹"],
      importance: 6,
      confidence: 7,
      screenshot_ids: [123, 124]
    }
  ],
  
  edges: [  // èŠ‚ç‚¹å…³ç³»
    {
      from_index: 0,  // Event node
      to_index: 1,    // Knowledge node
      edge_type: "derived_from"  // Knowledgeæ´¾ç”Ÿè‡ªEvent
    },
    {
      from_index: 0,
      to_index: 2,
      edge_type: "derived_from"  // Procedureæ´¾ç”Ÿè‡ªEvent
    }
  ]
}
```

#### 6.2 ç”Ÿæˆå¹‚ç­‰æ€§é”®(originKey)

**ä¸ºä»€ä¹ˆéœ€è¦ï¼Ÿ**

é˜²æ­¢é‡å¤å¤„ç†æ—¶åˆ›å»ºé‡å¤èŠ‚ç‚¹ã€‚å°±åƒå¿«é€’å•å·ï¼ŒåŒä¸€ä¸ªåŒ…è£¹å†å¯„ä¸€æ¬¡ï¼Œå•å·ä¸€æ ·å°±çŸ¥é“æ˜¯é‡å¤çš„ã€‚

```javascript
originKeyç”Ÿæˆè§„åˆ™:

Event node:
  originKey = "ctx_node:batch_001:ss:123,124:event"
  
Knowledge node (ç¬¬1ä¸ª):  
  originKey = "ctx_node:batch_001:ss:123,124:knowledge:1"

Knowledge node (ç¬¬2ä¸ª):
  originKey = "ctx_node:batch_001:ss:123,124:knowledge:2"
```

#### 6.3 æŒä¹…åŒ–åˆ°æ•°æ®åº“

```sql
INSERT INTO context_nodes (
  kind="event",
  threadId="thread_001",
  originKey="ctx_node:batch_001:ss:123,124:event",
  title="ç¼–å†™FastAPIç™»å½•æ¥å£",
  summary="...",
  keywords='["FastAPI","ç™»å½•"]',
  entities='[{name:"FastAPI",...}]',
  importance=7,
  confidence=9,
  eventTime=1736672987500,
  mergeStatus="pending",  â† è¿˜éœ€è¦åˆå¹¶ï¼
  mergeAttempts=0
)
RETURNING id;  -- è¿”å› nodeId=42

-- å…³è”æˆªå›¾
INSERT INTO screenshot_links (
  contextNodeId=42,
  screenshotId=123
)
```

**é‡è¦**: æ–°åˆ›å»ºçš„nodeçš„`mergeStatus`æ˜¯`pending`ï¼Œç­‰å¾…åç»­åˆå¹¶è°ƒåº¦ã€‚

---

### é˜¶æ®µ7: Context Node åˆå¹¶ ğŸ”—

**ä»£ç ä½ç½®**: `screenshot-pipeline-scheduler.ts` L1172-L1294

**ä¸ºä»€ä¹ˆè¦åˆå¹¶ï¼Ÿ**

æƒ³è±¡ä½ åœ¨å†™ä»£ç ï¼Œç³»ç»Ÿæ¯30ç§’æˆªä¸€æ¬¡å›¾ï¼š

```
16:30 â†’ åˆ›å»ºäº†loginå‡½æ•°
16:31 â†’ æ·»åŠ äº†å‚æ•°éªŒè¯  
16:32 â†’ å®ç°äº†tokenç”Ÿæˆ
16:33 â†’ æ·»åŠ äº†é”™è¯¯å¤„ç†
```

å¦‚æœæ¯æ¬¡éƒ½åˆ›å»ºæ–°èŠ‚ç‚¹ï¼Œå›¾è°±ä¼šå¾ˆä¹±ï¼åº”è¯¥æŠŠå®ƒä»¬**åˆå¹¶æˆä¸€ä¸ªèŠ‚ç‚¹**ï¼š"å®ç°ç™»å½•åŠŸèƒ½ï¼ˆåŒ…å«4æ¬¡è¿­ä»£ï¼‰"

#### 7.1 æŸ¥æ‰¾åˆå¹¶ç›®æ ‡

```javascript
æŸ¥æ‰¾è§„åˆ™ {
  WHERE 
    threadId = node.threadId  // åŒä¸€çº¿ç¨‹
    AND kind = node.kind      // åŒä¸€ç±»å‹ (éƒ½æ˜¯event)
    AND mergeStatus = "succeeded"  // å·²ç»æˆåŠŸçš„èŠ‚ç‚¹
    AND id != node.id         // ä¸æ˜¯è‡ªå·±
  ORDER BY eventTime DESC  // æœ€æ–°çš„ä¼˜å…ˆ
  LIMIT 1
}
```

**3ç§æƒ…å†µ**:

1. **æ²¡æœ‰threadId** â†’ æ— æ³•æ‰¾ç›®æ ‡ â†’ æ ‡è®°è‡ªå·±`mergeStatus=succeeded`ï¼ˆç‹¬ç«‹èŠ‚ç‚¹ï¼‰
   
2. **æ²¡æ‰¾åˆ°ç›®æ ‡** â†’ è¿™æ˜¯è¯¥çº¿ç¨‹çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ â†’ æ ‡è®°è‡ªå·±`succeeded`ï¼ˆé¦–ä¸ªèŠ‚ç‚¹ï¼‰

3. **æ‰¾åˆ°ç›®æ ‡** â†’ æ‰§è¡Œåˆå¹¶

#### 7.2 æ‰§è¡Œåˆå¹¶

**åˆå¹¶ç­–ç•¥**ï¼ˆå¯å‘å¼ + LLMå¢å¼ºï¼‰:

```javascript
åˆå¹¶é€»è¾‘ {
  // 1. Titleåˆå¹¶
  title = mergeText(
    existing.title="ç¼–å†™ç™»å½•å‡½æ•°",
    new.title="æ·»åŠ é”™è¯¯å¤„ç†",
    maxLen=100
  )
  â†’ "ç¼–å†™ç™»å½•å‡½æ•° / æ·»åŠ é”™è¯¯å¤„ç†"
  
  // 2. Summaryåˆå¹¶  
  summary = mergeText(existing.summary, new.summary, 200)
  â†’ ä¿ç•™æ›´é•¿çš„ï¼Œæˆ–æ‹¼æ¥
  
  // 3. Keywordså»é‡
  keywords = unique([...existing, ...new]).slice(0, 10)
  â†’ ["FastAPI", "ç™»å½•", "JWT", "é”™è¯¯å¤„ç†", "éªŒè¯"]
  
  // 4. Entitiesåˆå¹¶ï¼ˆä¿ç•™é«˜confidenceï¼‰
  entities = mergeByName([...existing, ...new])
  â†’ [{name:"FastAPI", confidence:0.9}, ...]
  
  // 5. Importance/Confidenceå–æœ€å¤§
  importance = max(existing.importance, new.importance)
  
  // 6. Screenshotsåˆå¹¶
  screenshotIds = unique([...existing, ...new])
  â†’ [123, 124, 125, 126]  // 4æ¬¡æˆªå›¾éƒ½å…³è”
  
  // 7. è®°å½•åˆå¹¶å†å²
  mergedFromIds = [node.id]  // è®°ä½è¢«åˆå¹¶çš„èŠ‚ç‚¹ID
}
```

**LLMå¢å¼ºåˆå¹¶**ï¼ˆå¯é€‰ï¼Œå¦‚æœText LLMå¯ç”¨ï¼‰:

```javascript
è¯·æ±‚Text LLM {
  ç³»ç»Ÿ: "ä½ æ˜¯ä¸ªä¸“ä¸šçš„å†…å®¹åˆå¹¶ä¸“å®¶...",
  ç”¨æˆ·: `
    ç°æœ‰èŠ‚ç‚¹: {
      title: "ç¼–å†™ç™»å½•å‡½æ•°",
      summary: "å®ç°äº†åŸºæœ¬çš„ç™»å½•é€»è¾‘..."
    }
    
    æ–°èŠ‚ç‚¹: {
      title: "æ·»åŠ é”™è¯¯å¤„ç†", 
      summary: "ä¸ºç™»å½•å‡½æ•°æ·»åŠ å¼‚å¸¸æ•è·å’Œé”™è¯¯è¿”å›..."
    }
    
    è¯·åˆå¹¶æˆä¸€ä¸ªæ›´å®Œæ•´çš„èŠ‚ç‚¹...
  `
}

LLMè¿”å› {
  title: "å®ç°ç™»å½•åŠŸèƒ½ï¼ˆå«é”™è¯¯å¤„ç†ï¼‰",
  summary: "å®Œæ•´å®ç°äº†ç”¨æˆ·ç™»å½•APIï¼ŒåŒ…æ‹¬è¯·æ±‚éªŒè¯ã€JWTç”Ÿæˆã€é”™è¯¯å¤„ç†å’Œå¼‚å¸¸è¿”å›...",
  keywords: [...],
  entities: [...]
}
```

#### 7.3 æ›´æ–°æ•°æ®åº“

```sql
-- 1. æ›´æ–°ç›®æ ‡èŠ‚ç‚¹
UPDATE context_nodes 
SET 
  title="å®ç°ç™»å½•åŠŸèƒ½ï¼ˆå«é”™è¯¯å¤„ç†ï¼‰",
  summary="...",
  keywords='[...]',
  entities='[...]',
  importance=8,
  confidence=9,
  mergedFromIds='[45]',  -- è®°å½•æ¥æºèŠ‚ç‚¹
  updatedAt=now
WHERE id=42;

-- 2. æŠŠæ–°èŠ‚ç‚¹çš„æˆªå›¾é“¾æ¥åˆ°ç›®æ ‡èŠ‚ç‚¹
INSERT INTO screenshot_links (contextNodeId=42, screenshotId=125);
INSERT INTO screenshot_links (contextNodeId=42, screenshotId=126);

-- 3. æ ‡è®°æ–°èŠ‚ç‚¹å·²è¢«åˆå¹¶
UPDATE context_nodes
SET mergeStatus="succeeded"
WHERE id=45;

-- 4. è§¦å‘å‘é‡æ–‡æ¡£æ›´æ–°ï¼ˆå¼‚æ­¥ï¼‰
-- vectorDocumentService.upsertForContextNode(42)
```

---

## ğŸ¯ ä¸‰ã€è°ƒåº¦å™¨å·¥ä½œåŸç†

### 3.1 è°ƒåº¦å™¨çš„è§’è‰²

æŠŠè°ƒåº¦å™¨æƒ³è±¡æˆä¸€ä¸ª**å·¥å‚è°ƒåº¦ä¸­å¿ƒ**ï¼Œè´Ÿè´£ï¼š

1. ğŸ“‹ **æ‰«æä»»åŠ¡**: æ¯éš”ä¸€æ®µæ—¶é—´æ£€æŸ¥æœ‰å“ªäº›å¾…åŠäº‹é¡¹
2. ğŸƒ **åˆ†é…å·¥äºº**: å†³å®šç”¨å‡ ä¸ªå·¥äººå¹¶å‘å¤„ç†
3. ğŸ”„ **å¤±è´¥é‡è¯•**: ä»»åŠ¡å¤±è´¥äº†ï¼Œå®‰æ’é‡æ–°å°è¯•
4. ğŸš¨ **å´©æºƒæ¢å¤**: ç³»ç»Ÿé‡å¯åï¼Œæ¢å¤æœªå®Œæˆçš„ä»»åŠ¡
5. â° **åŠ¨æ€è°ƒåº¦**: æ ¹æ®ä»»åŠ¡ç´§æ€¥ç¨‹åº¦è°ƒæ•´å·¥ä½œèŠ‚å¥

### 3.2 ä¸€è½®è°ƒåº¦å‘¨æœŸ(runCycle)

```
å¼€å§‹ä¸€è½®
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. å´©æºƒæ¢å¤                      â”‚
â”‚    æŠŠå¡æ­»çš„ä»»åŠ¡å›æ»šåˆ°pending      â”‚
â”‚    (è¶…è¿‡5åˆ†é’Ÿçš„runningçŠ¶æ€)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. æ‰«æå¾…å¤„ç†ä»»åŠ¡                 â”‚
â”‚    æŸ¥è¯¢ batches/context_nodes   â”‚
â”‚    WHERE status='pending'       â”‚
â”‚      AND nextRunAt <= now       â”‚
â”‚      AND attempts < 5           â”‚
â”‚    å–æ–°æ—§å„ä¸€åŠï¼Œæœ€å¤š200æ¡         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. å¹¶å‘å¤„ç†                      â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚    â”‚ Batch   â”‚  â”‚ Merge   â”‚    â”‚
â”‚    â”‚ Worker  â”‚  â”‚ Worker  â”‚    â”‚
â”‚    â”‚ (1-4ä¸ª) â”‚  â”‚ (1-10ä¸ª)â”‚    â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚         âˆ¥            âˆ¥          â”‚
â”‚      å¹¶è¡Œæ‰§è¡Œ    å¹¶è¡Œæ‰§è¡Œ        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. è¡¥æ•‘å­¤å„¿æˆªå›¾                  â”‚
â”‚    æ‰¾åˆ°é—æ¼çš„æˆªå›¾ï¼Œåˆ›å»ºbatch      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. å†³å®šä¸‹æ¬¡è¿è¡Œæ—¶é—´               â”‚
â”‚    - æœ‰wakeè¯·æ±‚ â†’ ç«‹å³å†è·‘        â”‚
â”‚    - æœ‰å¾…åŠä»»åŠ¡ â†’ æŒ‰nextRunAtè°ƒåº¦ â”‚
â”‚    - æ— ä»»åŠ¡    â†’ 60ç§’åè½®è¯¢       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.3 é‡è¯•æœºåˆ¶ï¼ˆæŒ‡æ•°é€€é¿ï¼‰

**åœºæ™¯**: VLM APIè°ƒç”¨è¶…æ—¶

```
ç¬¬1æ¬¡å¤±è´¥
  â†“
attempts = 1
nextRunAt = now + 5ç§’ + éšæœº0-10ç§’
status = "failed"
  â†“
5-15ç§’åé‡è¯•
  â†“
ç¬¬2æ¬¡å¤±è´¥
  â†“  
attempts = 2  
nextRunAt = now + 15ç§’ + éšæœº0-10ç§’
  â†“
15-25ç§’åé‡è¯•
  â†“
ç¬¬3æ¬¡å¤±è´¥
  â†“
attempts = 3
nextRunAt = now + 60ç§’ + éšæœº0-10ç§’
  â†“
...ç»§ç»­é‡è¯•...
  â†“
ç¬¬5æ¬¡å¤±è´¥
  â†“
attempts = 5 (è¾¾åˆ°ä¸Šé™)
status = "failed_permanent"  â† æ°¸ä¹…å¤±è´¥ï¼Œä¸å†é‡è¯•
```

**é€€é¿æ—¶é—´è¡¨**:
```
ç¬¬1æ¬¡: 5ç§’
ç¬¬2æ¬¡: 15ç§’
ç¬¬3æ¬¡: 60ç§’ (1åˆ†é’Ÿ)
ç¬¬4æ¬¡: 300ç§’ (5åˆ†é’Ÿ)  
ç¬¬5æ¬¡: 600ç§’ (10åˆ†é’Ÿ)
```

**ä¸ºä»€ä¹ˆè¦é€€é¿ï¼Ÿ**

1. é¿å…ç–¯ç‹‚é‡è¯•æµªè´¹èµ„æº
2. ç»™å¤–éƒ¨æœåŠ¡æ¢å¤æ—¶é—´ï¼ˆæ¯”å¦‚VLM APIä¸´æ—¶æ•…éšœï¼‰
3. éšæœºæŠ–åŠ¨é¿å…"æƒŠç¾¤"ï¼ˆå¾ˆå¤šä»»åŠ¡åŒæ—¶é‡è¯•ï¼‰

### 3.4 å´©æºƒæ¢å¤

**åœºæ™¯**: ç³»ç»Ÿå´©æºƒ/é‡å¯ï¼Œæ•°æ®åº“é‡Œæœ‰äº›ä»»åŠ¡å¡åœ¨`running`çŠ¶æ€

```sql
-- æ¯è½®å¼€å§‹å‰æ‰§è¡Œ
UPDATE batches
SET 
  status = 'pending',
  nextRunAt = null,
  updatedAt = now
WHERE 
  status = 'running'
  AND updatedAt < (now - 5åˆ†é’Ÿ);
  
-- æ„æ€: å¦‚æœä¸€ä¸ªä»»åŠ¡"running"è¶…è¿‡5åˆ†é’Ÿè¿˜æ²¡æ›´æ–°ï¼Œ
--      è‚¯å®šæ˜¯å´©æºƒäº†ï¼Œå›æ»šåˆ°pendingé‡æ–°è·‘
```

**ä¸ºä»€ä¹ˆ5åˆ†é’Ÿï¼Ÿ**

- æ­£å¸¸batchå¤„ç†: VLM(30ç§’) + Text(10ç§’) = çº¦1åˆ†é’Ÿ
- 5åˆ†é’Ÿæ˜¯å®‰å…¨è¾¹é™…ï¼Œé¿å…è¯¯å›æ»šæ­£åœ¨æ‰§è¡Œçš„æ…¢ä»»åŠ¡

### 3.5 å¹¶å‘æ§åˆ¶ - Laneåˆ†æµ

**ä¸ºä»€ä¹ˆéœ€è¦åˆ†æµï¼Ÿ**

å‡è®¾æœ‰100ä¸ªå¾…å¤„ç†ä»»åŠ¡ï¼š
- 95ä¸ªæ˜¯ä»Šå¤©æ–°äº§ç”Ÿçš„
- 5ä¸ªæ˜¯æ˜¨å¤©å¤±è´¥é‡è¯•çš„

å¦‚æœä¸åˆ†æµï¼Œæ–°ä»»åŠ¡å…¨éƒ¨ä¼˜å…ˆï¼Œé‚£5ä¸ªè€ä»»åŠ¡æ°¸è¿œæ’ä¸åˆ°ï¼

**Laneåˆ†æµç­–ç•¥**:
```javascript
åˆ†ç±»è§„åˆ™ {
  for (const task of tasks) {
    if (task.attempts > 0) {
      // é‡è¯•ä»»åŠ¡ â†’ Recovery Lane
      recovery.push(task)
    } else if (task.age > 5åˆ†é’Ÿ) {
      // ç§¯å‹ä»»åŠ¡ â†’ Recovery Lane  
      recovery.push(task)
    } else {
      // æ–°é²œä»»åŠ¡ â†’ Realtime Lane
      realtime.push(task)
    }
  }
}

èµ„æºåˆ†é… {
  æ€»å¹¶å‘: 4ä¸ªworker
  
  Realtime Lane: 3ä¸ªworker (75%)
  Recovery Lane: 1ä¸ªworker (25%)
  
  // ä¿è¯æ–°ä»»åŠ¡å¿«é€Ÿå¤„ç†ï¼Œè€ä»»åŠ¡ä¹Ÿä¸é¥¿æ­»
}
```

### 3.6 åŠ¨æ€è°ƒåº¦

**æ ¹æ®ä»»åŠ¡çŠ¶æ€æ™ºèƒ½è°ƒåº¦ï¼Œä¸åšæ— æ•ˆè½®è¯¢**

```javascript
è®¡ç®—ä¸‹æ¬¡è¿è¡Œæ—¶é—´ {
  candidates = []
  
  // 1. æœ€æ—©çš„pending batch
  batch = SELECT MIN(nextRunAt) FROM batches 
          WHERE status='pending' AND nextRunAt IS NOT NULL
  candidates.push(batch.nextRunAt)
  
  // 2. æœ€æ—©çš„pending merge
  merge = SELECT MIN(mergeNextRunAt) FROM context_nodes
          WHERE mergeStatus='pending' AND mergeNextRunAt IS NOT NULL
  candidates.push(merge.nextRunAt)
  
  // 3. æœ€æ—©çš„å­¤å„¿æˆªå›¾
  orphan = SELECT MIN(createdAt) FROM screenshots
           WHERE enqueuedBatchId IS NULL
  candidates.push(orphan.createdAt + 35ç§’)
  
  earliestNextRun = MIN(candidates)
  
  if (earliestNextRun === null) {
    delay = 60ç§’  // æ— ä»»åŠ¡ï¼Œ60ç§’åè½®è¯¢
  } else {
    delay = MAX(0, earliestNextRun - now)  // ç²¾ç¡®ç­‰åˆ°ä»»åŠ¡åˆ°æœŸ
  }
  
  setTimeout(runCycle, delay)
}
```

**æ•ˆæœ**:
- æœ‰ä»»åŠ¡åˆ°æœŸ â†’ ç²¾ç¡®è°ƒåº¦ï¼ˆæ¯”å¦‚15ç§’åï¼‰
- æ— ä»»åŠ¡ â†’ 60ç§’è½®è¯¢ä¸€æ¬¡
- èŠ‚çœCPUï¼Œä¸ç©ºè½¬

---

## ğŸ”„ å››ã€æ•°æ®åº“çŠ¶æ€æµè½¬

### çŠ¶æ€æœºå›¾ä¾‹è¯´æ˜

#### BatchçŠ¶æ€æµè½¬
```
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ pending  â”‚ â† åˆå§‹çŠ¶æ€
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ (è°ƒåº¦å™¨claim)
         â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ running  â”œâ”€â”€â”€â”€â”€â”€(æˆåŠŸ)â”€â”€â”€â”€â†’ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚ succeeded â”‚ âœ“ å®Œæˆ
         â”‚                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ (å¤±è´¥)
         â”‚
         â”œâ”€â”€â”€â”€(é‡è¯•,attempts<5)â”€â”€â”€â†’ å›åˆ°pending
         â”‚
         â””â”€â”€â”€â”€(é‡è¯•5æ¬¡éƒ½å¤±è´¥)â”€â”€â”€â”€â”€â†’ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                  â”‚failed_permanentâ”‚ âœ— æ°¸ä¹…å¤±è´¥
                                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å…³é”®å­—æ®µ**:
- `status`: pending | running | succeeded | failed_permanent
- `attempts`: 0-5
- `nextRunAt`: ä¸‹æ¬¡è¿è¡Œæ—¶é—´ï¼ˆå¤±è´¥åè®¾ç½®ï¼‰
- `errorMessage`: é”™è¯¯ä¿¡æ¯

#### Screenshot VLMçŠ¶æ€æµè½¬

```
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ pending  â”‚ â† æˆªå›¾åˆšåˆ›å»º
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ (æ‰€å±batchå¼€å§‹å¤„ç†)
         â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ running  â”œâ”€â”€â”€â”€â”€â”€(batchæˆåŠŸ)â”€â”€â”€â”€â†’ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚ succeeded â”‚ âœ“
         â”‚                             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â””â”€â”€â”€â”€â”€â”€(batchå¤±è´¥)â”€â”€â”€â”€â”€â†’ å›åˆ°pendingæˆ–failed_permanent
```

**ç‰¹ç‚¹**: æˆªå›¾çš„çŠ¶æ€è·Ÿéšbatchï¼Œä¸å•ç‹¬é‡è¯•

#### Context Node MergeçŠ¶æ€æµè½¬

```
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ pending  â”‚ â† nodeåˆšåˆ›å»º
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ (è°ƒåº¦å™¨claim)
         â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ running  â”œâ”€â”€â”€â”€â”€â”€(åˆå¹¶æˆåŠŸ)â”€â”€â”€â”€â†’ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚ succeeded â”‚ âœ“
         â”‚                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ (å¤±è´¥)
         â”œâ”€â”€â”€â”€(é‡è¯•,attempts<5)â”€â”€â”€â†’ å›åˆ°pending
         â”‚
         â””â”€â”€â”€â”€(é‡è¯•5æ¬¡éƒ½å¤±è´¥)â”€â”€â”€â”€â”€â†’ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                  â”‚failed_permanentâ”‚ âœ—
                                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å…³é”®å­—æ®µ**:
- `mergeStatus`: pending | running | succeeded | failed_permanent
- `mergeAttempts`: 0-5
- `mergeNextRunAt`: ä¸‹æ¬¡å°è¯•æ—¶é—´

---

## ğŸ“Š äº”ã€æ€§èƒ½ä¼˜åŒ–è¦ç‚¹

### 5.1 ä¸ºä»€ä¹ˆæ‰«æ"æ–°+æ—§"å„ä¸€åŠï¼Ÿ

```javascript
æ‰«æç­–ç•¥ {
  limit = 100
  
  // æ–¹æ¡ˆ1: åªæ‰«æœ€æ–°çš„100æ¡
  SELECT * FROM batches ORDER BY createdAt DESC LIMIT 100
  âŒ é—®é¢˜: æ—§ä»»åŠ¡æ°¸è¿œè½®ä¸åˆ°
  
  // æ–¹æ¡ˆ2: åªæ‰«æœ€è€çš„100æ¡  
  SELECT * FROM batches ORDER BY createdAt ASC LIMIT 100
  âŒ é—®é¢˜: æ–°ä»»åŠ¡å“åº”æ…¢
  
  // âœ… æ–¹æ¡ˆ3: æ–°æ—§å„50æ¡
  newest = SELECT * ORDER BY createdAt DESC LIMIT 50
  oldest = SELECT * ORDER BY createdAt ASC LIMIT 50
  merge(newest, oldest) â†’ å»é‡å¾—åˆ°æœ€ç»ˆåˆ—è¡¨
  
  ä¼˜ç‚¹:
  - æ–°ä»»åŠ¡å¿«é€Ÿå“åº”
  - æ—§ä»»åŠ¡ä¹Ÿèƒ½æ¨è¿›
  - å…¬å¹³è°ƒåº¦
}
```

### 5.2 ä¸ºä»€ä¹ˆbatch workeråªç”¨ä¸€åŠVLMå¹¶å‘ï¼Ÿ

```javascript
å¹¶å‘å±‚çº§ {
  VLMå…¨å±€å¹¶å‘: 4
  
  // å¦‚æœbatch worker = 4
  âŒ é—®é¢˜: å¯èƒ½åŒæ—¶å¤„ç†4ä¸ªbatchï¼Œæ¯ä¸ªbatchæœ‰3ä¸ªshard
        â†’ 12ä¸ªshardæ’é˜Ÿç­‰4ä¸ªVLM slot
        â†’ èµ„æºæµªè´¹ï¼Œä»»åŠ¡ç§¯å‹
  
  // âœ… batch worker = 2  
  æœ€å¤š2ä¸ªbatchå¹¶å‘
  æ¯ä¸ªbatchæœ€å¤š3ä¸ªshard
  â†’ æœ€å¤š6ä¸ªshardäº‰æŠ¢4ä¸ªVLM slot
  â†’ åˆç†é¥±å’Œï¼Œä¸è¿‡åº¦æ’é˜Ÿ
}
```

### 5.3 ä¸ºä»€ä¹ˆè¦ä¿ç•™textå¹¶å‘ç»™å…¶ä»–ä»»åŠ¡ï¼Ÿ

```javascript
Text LLMç”¨é€” {
  1. Batchæ‰©å±• (æœ¬è°ƒåº¦å™¨)
  2. Mergeåˆå¹¶ (æœ¬è°ƒåº¦å™¨)
  3. Activity Summaryç”Ÿæˆ (å…¶ä»–æ¨¡å—)  â† ä¹Ÿå¾ˆé‡è¦!
}

å¦‚æœä¸ä¿ç•™ {
  textLimit = 4
  mergeWorkerå¯èƒ½ç”¨æ»¡å…¨éƒ¨4ä¸ª
  â†’ Activity Summaryæ°¸è¿œæŠ¢ä¸åˆ°èµ„æº
  â†’ ç”¨æˆ·çœ‹ä¸åˆ°æ´»åŠ¨æ€»ç»“
}

âœ… ä¿ç•™ç­–ç•¥ {
  textLimit = 4
  reserved = 2 (ç»™Activity Summary)
  batchWorkeræœ€å¤šå ç”¨ = 2
  mergeWorker = 4 - 2 - batchWorker = 0~2
  
  â†’ ä¿è¯Summaryä¹Ÿèƒ½åŠæ—¶ç”Ÿæˆ
}
```

---

## ğŸ¨ å…­ã€å›¾è§£æ€»ç»“

### å®Œæ•´æµç¨‹å›¾

åˆšæ‰æˆ‘ä»¬çœ‹åˆ°çš„ç¬¬äºŒå¼ å›¾ï¼ˆè“ç´«è‰²æ¸å˜å¡ç‰‡ï¼‰å±•ç¤ºäº†**æ•°æ®åœ¨å„é˜¶æ®µçš„è½¬æ¢**ï¼š

1. **Screenshot Captured** (ç›¸æœºå›¾æ ‡)
   - åŸå§‹æ•°æ®: timestamp, filePath, appHint
   
2. **Batch Created** (åŒ…è£¹å›¾æ ‡)
   - ç»„ç»‡æ•°æ®: batchId, 5å¼ æˆªå›¾, historyPack
   
3. **VLM Analysis** (æœºå™¨äººçœ¼ç›)
   - ç†è§£æ•°æ®: segments, entities, keywords
   
4. **Text Expansion** (æ–‡æ¡£å †æ ˆ)
   - ç»“æ„åŒ–æ•°æ®: nodes, edges, threadId
   
5. **Context Node** (å›¾è°±èŠ‚ç‚¹)
   - æœ€ç»ˆæ•°æ®: id, kind, mergeStatus, å…³è”æˆªå›¾

### è°ƒåº¦æœºåˆ¶å›¾

ç¬¬ä¸€å¼ å›¾ï¼ˆæ¼«ç”»æœºå™¨äººï¼‰å±•ç¤ºäº†**è°ƒåº¦å™¨çš„4ä¸ªæ ¸å¿ƒèƒ½åŠ›**ï¼š

1. **Crash Recovery** (å·¦ä¸Š)
   - ä»»åŠ¡å¡æ­» â†’ è°ƒåº¦å™¨å¤æ´»å®ƒ
   
2. **Retry with Backoff** (å³ä¸Š)
   - å¤±è´¥ä»»åŠ¡ â†’ ç­‰15ç§’å†è¯•
   
3. **Concurrent Processing** (å·¦ä¸‹)
   - å¿«è½¦é“(75%) vs æ…¢è½¦é“(25%)
   
4. **Dynamic Scheduling** (å³ä¸‹)
   - æ™ºèƒ½ä¼‘çœ ï¼ŒæŒ‰æ—¶å”¤é†’

### çŠ¶æ€æœºå›¾

ç¬¬ä¸‰å¼ å›¾å±•ç¤ºäº†**æ•°æ®åº“çŠ¶æ€çš„ç”Ÿå‘½å‘¨æœŸ**ï¼š

- **é»„è‰²**: pending (ç­‰å¾…å¤„ç†)
- **è“è‰²**: running (æ­£åœ¨å¤„ç†)
- **ç»¿è‰²**: succeeded (å®Œæˆâœ“)
- **çº¢è‰²**: failed_permanent (æ°¸ä¹…å¤±è´¥âœ—)

---

## â“ ä¸ƒã€å¸¸è§é—®é¢˜è§£ç­”

### Q1: ä¸ºä»€ä¹ˆæˆªå›¾è¦å»é‡ï¼Ÿ

**A**: æƒ³è±¡ä½ ç›¯ç€åŒä¸€ä¸ªé¡µé¢çœ‹äº†1åˆ†é’Ÿï¼Œç³»ç»Ÿæ¯5ç§’æˆªå›¾ä¸€æ¬¡ â†’ 12å¼ å®Œå…¨ç›¸åŒçš„å›¾ã€‚

å»é‡ååªä¿ç•™1å¼ ï¼ŒèŠ‚çœï¼š
- ğŸ’¾ å­˜å‚¨ç©ºé—´ï¼ˆå›¾ç‰‡å¾ˆå¤§ï¼‰
- ğŸ’° VLMè°ƒç”¨è´¹ç”¨ï¼ˆæ¯å¼ å›¾éƒ½è¦èŠ±é’±ï¼‰
- âš¡ å¤„ç†æ—¶é—´

### Q2: å­¤å„¿æˆªå›¾æ˜¯æ€ä¹ˆäº§ç”Ÿçš„ï¼Ÿ

**åœºæ™¯**: 
1. ç³»ç»Ÿæ­£åœ¨æ”¶é›†æˆªå›¾åˆ°buffer
2. è¿˜æ²¡å‡‘å¤Ÿ5å¼ 
3. çªç„¶å´©æºƒ/é‡å¯
4. Bufferä¸¢å¤±ï¼Œä½†æˆªå›¾å·²å…¥åº“

ç»“æœ: æ•°æ®åº“é‡Œæœ‰æˆªå›¾ï¼Œä½†æ²¡æœ‰batch â†’ å­¤å„¿

**è§£å†³**: è°ƒåº¦å™¨æ¯è½®ç»“æŸéƒ½æ£€æŸ¥å­¤å„¿ï¼Œè¶…è¿‡35ç§’æœªå…¥é˜Ÿçš„è‡ªåŠ¨åˆ›å»ºbatch

### Q3: ä¸ºä»€ä¹ˆéœ€è¦å´©æºƒæ¢å¤ï¼Ÿ

**åœºæ™¯**:
1. Batchæ­£åœ¨å¤„ç†(status=running)
2. ç³»ç»Ÿå´©æºƒ
3. é‡å¯åï¼Œbatchè¿˜æ˜¯running
4. ä½†æ²¡æœ‰è¿›ç¨‹åœ¨å¤„ç†å®ƒäº†

**ä¸æ¢å¤çš„åæœ**: ä»»åŠ¡æ°¸ä¹…å¡ä½

**æ¢å¤æœºåˆ¶**: `updatedAt`å½“ä½œå¿ƒè·³ï¼Œè¶…è¿‡5åˆ†é’Ÿæ²¡æ›´æ–° â†’ åˆ¤å®šå´©æºƒ â†’ å›æ»šåˆ°pending

### Q4: ä¸ºä»€ä¹ˆè¦åˆå¹¶èŠ‚ç‚¹ï¼Ÿ

**ä¸åˆå¹¶çš„é—®é¢˜**:
```
16:30 â†’ Node1: "å†™äº†loginå‡½æ•°"
16:31 â†’ Node2: "æ·»åŠ äº†å‚æ•°"  
16:32 â†’ Node3: "æ·»åŠ äº†è¿”å›å€¼"
16:33 â†’ Node4: "æ·»åŠ äº†æ³¨é‡Š"

â†’ 4ä¸ªç¢ç‰‡åŒ–çš„èŠ‚ç‚¹ï¼Œå¾ˆéš¾ç†è§£å®Œæ•´é€»è¾‘
```

**åˆå¹¶å**:
```
16:30-16:33 â†’ Node1: "å®ç°äº†loginåŠŸèƒ½ï¼ˆåŒ…å«å‚æ•°éªŒè¯ã€è¿”å›å¤„ç†å’Œæ³¨é‡Šï¼‰"
              screenshotIds: [1,2,3,4]
              mergedFromIds: [2,3,4]

â†’ 1ä¸ªå®Œæ•´çš„èŠ‚ç‚¹ï¼Œæ¸…æ™°æè¿°æ•´ä¸ªå¼€å‘è¿‡ç¨‹
```

### Q5: Text LLMå¤±è´¥ä¸ºä»€ä¹ˆä¸é˜»å¡æµç¨‹ï¼Ÿ

**è®¾è®¡ç†å¿µ**: VLMè¾“å‡ºå·²ç»åŒ…å«åŸºç¡€ä¿¡æ¯ï¼ŒText LLMåªæ˜¯"é”¦ä¸Šæ·»èŠ±"

```
VLMè¾“å‡º: 
  segments: [{title, summary, keywords}]
  entities: [...]
  
Text LLMå¤±è´¥ â†“

Fallback: ç›´æ¥è½¬æ¢VLM segmentsä¸ºnodes
  â†’ node.title = segment.event.title
  â†’ node.summary = segment.event.summary
  â†’ è´¨é‡ç¨å·®ï¼Œä½†æ•°æ®å®Œæ•´
```

**å®¹é”™ > å®Œç¾**: ä¿è¯æ•°æ®ä¸ä¸¢ï¼Œæ¯”ç­‰å¾…LLMä¿®å¤æ›´é‡è¦

---

## ğŸ“ å…«ã€æ€»ç»“

è¿™ä¸ªæˆªå›¾å¤„ç†æµæ°´çº¿æ˜¯ä¸€ä¸ª**å¥å£®ã€æ™ºèƒ½ã€å¯æ‰©å±•**çš„ç³»ç»Ÿï¼š

### æ ¸å¿ƒç‰¹æ€§

1. âœ… **è‡ªåŠ¨å»é‡**: pHashé˜²æ­¢é‡å¤å¤„ç†
2. âœ… **æ‰¹é‡ä¼˜åŒ–**: 5å¼ ä¸€ç»„ï¼Œæé«˜AIæ•ˆç‡
3. âœ… **å¹¶å‘å¤„ç†**: Shardåˆ†ç‰‡ + Semaphoreé™æµ
4. âœ… **å¤±è´¥é‡è¯•**: æŒ‡æ•°é€€é¿ + éšæœºæŠ–åŠ¨
5. âœ… **å´©æºƒæ¢å¤**: updatedAtå¿ƒè·³æ£€æµ‹
6. âœ… **æ™ºèƒ½è°ƒåº¦**: Laneåˆ†æµ + åŠ¨æ€æ—¶é—´
7. âœ… **å¹‚ç­‰æ€§**: originKeyé˜²é‡å¤
8. âœ… **å®¹é”™è®¾è®¡**: Text LLMå¤±è´¥æœ‰fallback

### æ•°æ®æµæ€»ç»“

```
åŸå§‹æˆªå›¾ (ğŸ“· binary)
  â†“ å»é‡+å…¥åº“
Buffer (ğŸ“¦ ä¸´æ—¶å­˜å‚¨)
  â†“ è§¦å‘æ¡ä»¶
Batch (ğŸ 5å¼ ä¸€ç»„)
  â†“ åˆ†ç‰‡
Shards (ğŸ“‘ å¹¶è¡Œå•å…ƒ)
  â†“ VLMåˆ†æ
VLM Index (ğŸ¤– ç»“æ„åŒ–ç†è§£)
  â†“ Textæ‰©å±•
Context Nodes (ğŸ“ çŸ¥è¯†èŠ‚ç‚¹)
  â†“ åˆå¹¶
Knowledge Graph (ğŸ•¸ï¸ çŸ¥è¯†å›¾è°±)
```

### è°ƒåº¦å™¨æ€»ç»“

```
è°ƒåº¦ä¸­å¿ƒ (âš™ï¸ Scheduler)
  â”œâ”€ å´©æºƒæ¢å¤ (ğŸš‘ running â†’ pending)
  â”œâ”€ æ‰«æä»»åŠ¡ (ğŸ” pending + failed)
  â”œâ”€ Laneåˆ†æµ (ğŸ›£ï¸ realtime + recovery)
  â”œâ”€ å¹¶å‘æ‰§è¡Œ (ğŸƒ batch + merge workers)
  â”œâ”€ å¤±è´¥é‡è¯• (ğŸ”„ backoff + jitter)
  â””â”€ åŠ¨æ€è°ƒåº¦ (â° nextRunAt)
```

### æœ€ç»ˆæ•ˆæœ

ç”¨æˆ·æ— éœ€å…³å¿ƒè¿™äº›å¤æ‚çš„åå°å¤„ç†ï¼Œåªéœ€ï¼š
1. æ­£å¸¸ä½¿ç”¨ç”µè„‘
2. ç³»ç»Ÿè‡ªåŠ¨æˆªå›¾
3. AIè‡ªåŠ¨åˆ†æå½’æ¡£
4. éšæ—¶æœç´¢å†å²æ´»åŠ¨

**ä¸€åˆ‡éƒ½åœ¨åå°é™é»˜å®Œæˆï¼** ğŸ‰
