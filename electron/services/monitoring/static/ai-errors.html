<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title data-i18n="monitoring.aiErrorsTitle">AI Errors</title>
  <style>
    :root {
      --bg-primary: #0f172a;
      --bg-secondary: #1e293b;
      --bg-tertiary: #334155;
      --text-primary: #f8fafc;
      --text-secondary: #94a3b8;
      --text-muted: #64748b;
      --border-color: #475569;
      --accent-blue: #3b82f6;
      --accent-green: #22c55e;
      --accent-yellow: #eab308;
      --accent-red: #ef4444;
      --accent-purple: #a855f7;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      padding: 24px;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }

    .header h1 {
      font-size: 24px;
      font-weight: 600;
    }

    .header-links a {
      color: var(--accent-blue);
      text-decoration: none;
      margin-left: 16px;
      font-size: 14px;
    }

    .header-links a:hover {
      text-decoration: underline;
    }

    .error-rates {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .rate-card {
      background: var(--bg-secondary);
      border-radius: 12px;
      padding: 20px;
    }

    .rate-card-title {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 16px;
    }

    .rate-items {
      display: flex;
      gap: 24px;
    }

    .rate-item {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .rate-item-label {
      font-size: 12px;
      color: var(--text-muted);
    }

    .rate-item-value {
      font-size: 24px;
      font-weight: 600;
    }

    .rate-item-value.vlm { color: var(--accent-purple); }
    .rate-item-value.text { color: var(--accent-blue); }
    .rate-item-value.embedding { color: var(--accent-green); }

    .sections-grid {
      display: grid;
      grid-template-columns: 1fr 2fr;
      gap: 16px;
    }

    @media (max-width: 900px) {
      .sections-grid {
        grid-template-columns: 1fr;
      }
    }

    .top-errors {
      background: var(--bg-secondary);
      border-radius: 12px;
      padding: 20px;
    }

    .section-title {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 16px;
    }

    .error-list {
      list-style: none;
    }

    .error-list-item {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid var(--border-color);
    }

    .error-list-item:last-child {
      border-bottom: none;
    }

    .error-code {
      font-family: monospace;
      font-size: 13px;
      color: var(--accent-red);
    }

    .error-count {
      font-size: 13px;
      color: var(--text-secondary);
    }

    .error-stream {
      background: var(--bg-secondary);
      border-radius: 12px;
      padding: 20px;
      max-height: 500px;
      overflow-y: auto;
    }

    .error-table {
      width: 100%;
      border-collapse: collapse;
    }

    .error-table th,
    .error-table td {
      text-align: left;
      padding: 10px 12px;
      border-bottom: 1px solid var(--border-color);
      font-size: 13px;
    }

    .error-table th {
      font-size: 11px;
      color: var(--text-muted);
      font-weight: 500;
      text-transform: uppercase;
      position: sticky;
      top: 0;
      background: var(--bg-secondary);
    }

    .error-table td.time {
      color: var(--text-muted);
      white-space: nowrap;
    }

    .error-table td.capability {
      text-transform: uppercase;
      font-weight: 500;
    }

    .error-table td.capability.vlm { color: var(--accent-purple); }
    .error-table td.capability.text { color: var(--accent-blue); }
    .error-table td.capability.embedding { color: var(--accent-green); }

    .error-table td.error-code {
      font-family: monospace;
      color: var(--accent-red);
    }

    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-muted);
    }

    .footer {
      margin-top: 24px;
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      color: var(--text-muted);
    }

    .status-dot {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 6px;
    }

    .status-dot.connected { background: var(--accent-green); }
    .status-dot.disconnected { background: var(--accent-red); }
  </style>
</head>
<body>
  <div class="header">
    <h1 data-i18n="monitoring.aiErrorsTitle">AI Errors</h1>
    <div class="header-links">
      <a href="/" data-i18n="monitoring.title">Performance Monitor</a>
    </div>
  </div>

  <div class="error-rates">
    <div class="rate-card">
      <div class="rate-card-title" data-i18n="monitoring.aiErrors.last1Min">Last 1 min</div>
      <div class="rate-items">
        <div class="rate-item">
          <span class="rate-item-label">VLM</span>
          <span class="rate-item-value vlm" id="rate-1m-vlm">0</span>
        </div>
        <div class="rate-item">
          <span class="rate-item-label">Text</span>
          <span class="rate-item-value text" id="rate-1m-text">0</span>
        </div>
        <div class="rate-item">
          <span class="rate-item-label">Embedding</span>
          <span class="rate-item-value embedding" id="rate-1m-embedding">0</span>
        </div>
      </div>
    </div>

    <div class="rate-card">
      <div class="rate-card-title" data-i18n="monitoring.aiErrors.last5Min">Last 5 min</div>
      <div class="rate-items">
        <div class="rate-item">
          <span class="rate-item-label">VLM</span>
          <span class="rate-item-value vlm" id="rate-5m-vlm">0</span>
        </div>
        <div class="rate-item">
          <span class="rate-item-label">Text</span>
          <span class="rate-item-value text" id="rate-5m-text">0</span>
        </div>
        <div class="rate-item">
          <span class="rate-item-label">Embedding</span>
          <span class="rate-item-value embedding" id="rate-5m-embedding">0</span>
        </div>
      </div>
    </div>
  </div>

  <div class="sections-grid">
    <div class="top-errors">
      <div class="section-title" data-i18n="monitoring.aiErrors.topErrors">Top Error Codes</div>
      <ul class="error-list" id="top-errors-list">
        <li class="empty-state" data-i18n="monitoring.aiErrors.noErrors">No errors recorded</li>
      </ul>
    </div>

    <div class="error-stream">
      <div class="section-title" data-i18n="monitoring.aiErrors.errorStream">Recent Errors</div>
      <table class="error-table">
        <thead>
          <tr>
            <th data-i18n="monitoring.aiErrors.table.time">Time</th>
            <th data-i18n="monitoring.aiErrors.table.capability">Capability</th>
            <th data-i18n="monitoring.aiErrors.table.operation">Operation</th>
            <th data-i18n="monitoring.aiErrors.table.model">Model</th>
            <th data-i18n="monitoring.aiErrors.table.errorCode">Error Code</th>
          </tr>
        </thead>
        <tbody id="error-stream-body">
          <tr>
            <td colspan="5" class="empty-state" data-i18n="monitoring.aiErrors.noErrors">No errors recorded</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <div class="footer">
    <div>
      <span class="status-dot connected" id="connection-indicator"></span>
      <span id="connection-status">Connected</span>
    </div>
    <div>
      <span data-i18n="monitoring.footer.lastUpdated">Last updated</span>: <span id="last-updated">--</span>
    </div>
  </div>

  <script>
    // i18n translations
    const translations = {
      en: {
        monitoring: {
          title: "Performance Monitor",
          aiErrorsTitle: "AI Errors",
          aiErrors: {
            errorRate: "Error Rate",
            last1Min: "Last 1 min",
            last5Min: "Last 5 min",
            topErrors: "Top Error Codes",
            errorStream: "Recent Errors",
            noErrors: "No errors recorded",
            table: {
              time: "Time", capability: "Capability", operation: "Operation",
              model: "Model", errorCode: "Error Code"
            }
          },
          footer: { lastUpdated: "Last updated" },
          connection: { connected: "Connected", reconnecting: "Reconnecting..." }
        }
      },
      "zh-CN": {
        monitoring: {
          title: "性能监控",
          aiErrorsTitle: "AI 错误",
          aiErrors: {
            errorRate: "错误率",
            last1Min: "最近 1 分钟",
            last5Min: "最近 5 分钟",
            topErrors: "Top 错误码",
            errorStream: "最近错误",
            noErrors: "暂无错误记录",
            table: {
              time: "时间", capability: "功能", operation: "操作",
              model: "模型", errorCode: "错误码"
            }
          },
          footer: { lastUpdated: "最后更新" },
          connection: { connected: "已连接", reconnecting: "重新连接中..." }
        }
      }
    };

    // Error stream data
    const MAX_ERRORS = 50;
    const errors = [];

    // DOM elements
    const elements = {
      rate1mVlm: document.getElementById("rate-1m-vlm"),
      rate1mText: document.getElementById("rate-1m-text"),
      rate1mEmbedding: document.getElementById("rate-1m-embedding"),
      rate5mVlm: document.getElementById("rate-5m-vlm"),
      rate5mText: document.getElementById("rate-5m-text"),
      rate5mEmbedding: document.getElementById("rate-5m-embedding"),
      topErrorsList: document.getElementById("top-errors-list"),
      errorStreamBody: document.getElementById("error-stream-body"),
      connectionIndicator: document.getElementById("connection-indicator"),
      connectionStatus: document.getElementById("connection-status"),
      lastUpdated: document.getElementById("last-updated")
    };

    // Initialize i18n
    let currentTranslations = null;
    async function initI18n() {
      try {
        const res = await fetch('/api/locale');
        const { lang } = await res.json();
        currentTranslations = translations[lang]?.monitoring || translations.en.monitoring;
        
        document.querySelectorAll('[data-i18n]').forEach(el => {
          const key = el.dataset.i18n.replace('monitoring.', '');
          const value = key.split('.').reduce((obj, k) => obj?.[k], currentTranslations);
          if (value) el.textContent = value;
        });
        
        document.title = currentTranslations.aiErrorsTitle;
      } catch (e) {
        console.warn('Failed to load locale:', e);
        currentTranslations = translations.en.monitoring;
      }
    }

    function t(key) {
      if (!currentTranslations) return key;
      return key.split('.').reduce((obj, k) => obj?.[k], currentTranslations) || key;
    }

    // Format timestamp
    function formatTime(ts) {
      return new Date(ts).toLocaleTimeString();
    }

    // Render errors table
    function renderErrorsTable() {
      if (errors.length === 0) {
        elements.errorStreamBody.innerHTML = `
          <tr><td colspan="5" class="empty-state" data-i18n="monitoring.aiErrors.noErrors">No errors recorded</td></tr>
        `;
        return;
      }

      elements.errorStreamBody.innerHTML = errors
        .slice()
        .reverse()
        .slice(0, MAX_ERRORS)
        .map(e => `
          <tr>
            <td class="time">${formatTime(e.ts)}</td>
            <td class="capability ${e.capability}">${e.capability}</td>
            <td>${e.operation}</td>
            <td>${e.model}</td>
            <td class="error-code">${e.errorCode || 'unknown'}</td>
          </tr>
        `)
        .join('');
    }

    // Render top errors list
    function renderTopErrors(topErrors) {
      if (!topErrors || topErrors.length === 0) {
        elements.topErrorsList.innerHTML = `
          <li class="empty-state" data-i18n="monitoring.aiErrors.noErrors">No errors recorded</li>
        `;
        return;
      }

      elements.topErrorsList.innerHTML = topErrors
        .map(e => `
          <li class="error-list-item">
            <span class="error-code">${e.errorCode}</span>
            <span class="error-count">${e.count}</span>
          </li>
        `)
        .join('');
    }

    // Load error rates
    async function loadErrorRates() {
      try {
        const res = await fetch('/api/error-rates');
        const data = await res.json();
        
        elements.rate1mVlm.textContent = data.rate1m.vlm;
        elements.rate1mText.textContent = data.rate1m.text;
        elements.rate1mEmbedding.textContent = data.rate1m.embedding;
        
        elements.rate5mVlm.textContent = data.rate5m.vlm;
        elements.rate5mText.textContent = data.rate5m.text;
        elements.rate5mEmbedding.textContent = data.rate5m.embedding;
        
        renderTopErrors(data.topErrors);
      } catch (e) {
        console.warn('Failed to load error rates:', e);
      }
    }

    // Load recent errors
    async function loadRecentErrors() {
      try {
        const res = await fetch('/api/errors');
        const data = await res.json();
        errors.push(...data);
        renderErrorsTable();
      } catch (e) {
        console.warn('Failed to load recent errors:', e);
      }
    }

    // Handle new error from SSE
    function handleNewError(error) {
      errors.push(error);
      if (errors.length > MAX_ERRORS * 2) {
        errors.splice(0, errors.length - MAX_ERRORS);
      }
      renderErrorsTable();
      loadErrorRates();
      elements.lastUpdated.textContent = new Date().toLocaleTimeString();
    }

    // Handle init payload
    function handleInit(init) {
      errors.push(...init.recentErrors);
      renderErrorsTable();
      loadErrorRates();
    }

    // SSE connection
    function connectSSE() {
      const eventSource = new EventSource('/api/stream');
      
      eventSource.onopen = () => {
        elements.connectionIndicator.className = 'status-dot connected';
        elements.connectionStatus.textContent = t('connection.connected');
      };
      
      eventSource.onmessage = (event) => {
        const message = JSON.parse(event.data);
        
        if (message.type === 'init') {
          handleInit(message.data);
        } else if (message.type === 'ai_error') {
          handleNewError(message.data);
        }
      };
      
      eventSource.onerror = () => {
        elements.connectionIndicator.className = 'status-dot disconnected';
        elements.connectionStatus.textContent = t('connection.reconnecting');
      };
    }

    // Initialize
    initI18n();
    loadErrorRates();
    loadRecentErrors();
    connectSSE();

    // Refresh error rates periodically
    setInterval(loadErrorRates, 30000);
  </script>
</body>
</html>
